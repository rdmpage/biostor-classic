<?php

require_once('../config.inc.php');
require_once('../lib.php');

$djvu_string = '';


$Titles=array(
116226,116503
);
$want=array(

);

$Titles=array(
112965,65344,7414,8981
);
$want=array(
202229,202386,202512,202571
);

// http://biodiversitylibrary.org/bibliography/116503
// http://biodiversitylibrary.org/bibliography/112965
$Titles=array(
8981,
79076,
6170,
62643
);
$want=array(
// Rev Sui
203304,
203184,
// Naut
203169,
203168,
203167,
// Nota Lep
203185,
203048,
// J Lep
203166,
202862,
202847,
202846


);



$Titles=array(
118453,118615,8089,117069
);
$want=array(

);

$Titles=array(

6525
);
$want=array(
207082
);


$Titles=array(
11199
);
$want=array(
207100,
207114,
207146,
207147,
207171,
207186,
207190,
207193,
207234,
207235,
207423,
207447

);

$Titles=array(
119064
);
$want=array(
);


$Titles=array(
110135
);
$want=array(
207230,
207219,
207178,
207163,
207136
);

$Titles=array(
112965
);
$want=array(
200713,
202229,
203206,
204735,
207236,
207394,
207395,
207429

);

// Acta Botánica Mexicana
$Titles=array(
119685,
119760,
119766,
119767,
119773
);
$want=array(

);
$Titles=array(
114584
);
$want=array(
208273
);

$Titles=array(
5943,
61449,
8985
);
$want=array(

217367,

217476,
217512,

217331,
217332,
217364,
217391,
217504,
217561


);

$Titles=array(
125545, // Goeldiana zoologia
128759, // Nuytsia : bulletin of the Western Australian Herbarium.
129346,
126732, // Birds of Australia
129924
);
$want=array(

);

$Titles=array(
137899
);
$want=array(

);

$Titles=array(
142683, // 2007
142680, // 1984
142673, // 2008
142672, // 2001
142655, // 2002
142646, // 2006
142636, // 1989
142635, // 1978
142632, // 2007
142628, // 1999
142601, // 1990
142627, // 1991
142624, // 1987
142603, // 1976
142604, // bats of jamiaca
142603, // 1977
142601, // 1990
142599, // 2002
142597 // 2004

);

$Titles=array(
142952,
142951,
142950,
142949,
142948,
142945,
142943,
142936,
142933,
142930,
142926,
142925,
142922,
142921,
142916,
142914,
142913,
142912,
142907,
142906,
142895,
142894,
142892,
142891,
142890,
142889,
142888,
142873,
142871,
142870,
142868,
142867,
142866,
142865,
142861,
142854,
142847,
142828,
142825,
142816,
142815,
142814,
142805,
142804,
142803
);

$Titles=array(
45469,
143325,
143318,
143263,
143309,
143306,
143305,
143285,
143283,
143276,
143064,
143265,
143250,
143249,
143236,
143227,
143226,
143219,
143217,
143200,
143164,
143162,
143143,
143142,
143137,
143136,
143128,
143126,
143124,
124455
);

$Titles=array(
147045,
147060,
147024,
147002,
146997,
146994,
140981
);

$Titles=array(
146242,
147371,
147339,
147338,
147324,
147299
);

$Titles=array(
//138908
//86267
//6047
//42247

2270,
2328,
2255,
2233,
2435,
2411,
2397,
2409,
2413,
2403,
2456,
2385,
2448,
2434,
2396,
2390,
2443,
2421,
2387,
2402,
2438,
2301,
2380,
4224,
2288,
2414,
2404,
2422,
2400,
3843,
2247,
2297,
2444,
2398,
2410,
2391,
2442,
3851,
2417,
2431,
2445,
2394,
2394,
2451,
2427,
2420,
2408,
2388,
2392,
2407,
4816,
2393,
2418,
2439,
2457,
2419,
2405,
2389,
2432,
2428,
2415,
2429,
2447,
972	,
2450,
3847,
2452,
4961,
2449,
2430,
2406,
2384,
2412,
2399,
2386,
2425,
968	,
2436,
2617,
2648,
2651,
2567,
960	,
2623,
2629,
2660,
2599,
2590,
2608,
955	,
2606,
2582,
2644,
2555,
2561,
2577,
2663,
2571,
2627,
958	,
2416,
974	,
2437,
2383,
2381,
2446,
2382,
2454,
2433,
2453,
2401,
2426,
5638,
2538,
2552,
2650,
2613,
2541,
2643,
2607,
2591,
2624,
2614,
5639,
2593,
2655,
2600,
2565,
2664,
2628,
2652,
2659,
2537,
2602,
2586,
2559,
2612,
2549,
2540,
2641,
2620,
2598,
2542,
2547,
2550,
2662,
2604,
2536,
2649,
2626,
2618,
2636,
2594,
2543,
2569,
2573,
2658,

);


$Titles = array(
//574, // Enumeratio plantarum Zeylaniae 
//156405,
//156406

// J Bot Tex
//156612,
//156608,

//14650, 
/*
156819,

156843,
156835,
156831,
156825,
156821,
156816,
*/
156822,

);

$Titles=array(
157011,
157007,
157005,
157004,
157003,
156999,
156995,
156994,
156993,
156992,
156988,
156987,
156983,
156982,
156981,
156980,
156979,
156978,
156977,
156976,
156974,
156973,
156972,
156969,
156967,
156966,
156965,
156963,
156960,
156958,
156953,
156952,
156951,
156948,
156947,
156939,
156938,
156937,
156936,
156933,
156931,
156930,
156929,
156924,
156923,
156921,
156920,
156918,
156917,
156915,
156913,
156912,
156909,
156906,
156905,
156904,
156903,
156902,
156899,
156898,
156897,
156896,
156891,
156890,
156889,
156888,
156886,
156872,
140981,
140981,
140981,
140981,
156825,
140981,
140981,
140981,
140981,
);

$Titles = array(
//156823
//142707
//156869,
//156873,
//156875,
//156869,

//49731

//8649
//157691
/*
157796,
157799,
157801,

157802,
157803,
*/
//157010

//14688,

//158566

//69640

//158815,
//154994

//158879,
//158870,
//158834,

//158870

65144

);

$want=array(

);



foreach ($Titles as $TitleID)
{
 //$want=array();

$use_bhl_au = false;
//$use_bhl_au = true;

if ($use_bhl_au)
{
	// BHL AU
	$url = 'http://bhl.ala.org.au/api/rest?op=GetTitleMetadata&titleid=' . $TitleID . '&items=true&apikey=' . $config['bhl_api_key'] . '&format=json';
}
else
{
	// BHL
	$url = 'https://www.biodiversitylibrary.org/api2/httpquery.ashx?op=GetTitleMetadata&titleid=' . $TitleID . '&items=true&apikey=' . '0d4f0303-712e-49e0-92c5-2113a5959159' . '&format=json';
}

//echo $url . "\n";

$json = get($url);
$title_obj = json_decode($json);

//print_r($title_obj);
//exit();



if ($title_obj->Status == 'ok')
{

	$sql = "REPLACE INTO bhl_title(TitleID, FullTitle, ShortTitle, PartNumber) VALUES ("
		. $title_obj->Result->TitleID . ",'" . addslashes($title_obj->Result->FullTitle) . "','" . addslashes($title_obj->Result->ShortTitle) . "','" . addslashes($title_obj->Result->PartNumber) . "');";
	echo $sql . "\n";

	foreach ($title_obj->Result->Items as $item_obj)
	{
		$go = false;
		if (count($want) == 0)
		{
			$go = true;
		}
		else
		{
			if (in_array($item_obj->ItemID, $want))
			{
				$go = true;
			}
		}
		if ($go)
		{
		
			if ($use_bhl_au)
			{
				$url = 'http://bhl.ala.org.au/api/rest?op=GetItemMetadata&itemid=' . $item_obj->ItemID . '&pages=t&apikey=' . $config['bhl_api_key'] . '&format=json';
			}
			else
			{
				$url = 'http://www.biodiversitylibrary.org/api2/httpquery.ashx?op=GetItemMetadata&itemid=' . $item_obj->ItemID . '&pages=t&apikey=' . '0d4f0303-712e-49e0-92c5-2113a5959159' . '&format=json';
			}
			
			$json = get($url);
			
			$obj = json_decode($json);
			
			//print_r($obj);
			//exit();
			
			if (($obj->Status == 'ok') && ($obj->Result != '')) // ok doesn't mean we have anything :(
			{
				
				$djvu_string .= "'" . $obj->Result->ItemID . "' => '" .  $obj->Result->SourceIdentifier . "',\n";
			
				
				// Item
				$sql = "DELETE FROM bhl_item WHERE ItemID=" . $obj->Result->ItemID . ";";
				echo $sql . "\n";
				
				$sql = "INSERT INTO bhl_item(ItemID,TitleID,VolumeInfo) VALUES("
				. $obj->Result->ItemID . ',' . $obj->Result->PrimaryTitleID . ",'" . addslashes($obj->Result->Volume) . "');";
				
				echo $sql . "\n";
				
				$sql = 'DELETE FROM bhl_page WHERE ItemID=' . $obj->Result->ItemID . ";";
				echo $sql;
		
		
				// Pages
				foreach ($obj->Result->Pages as $k => $v)
				{
					// Metadata about pages
					$keys = array();
					$values = array();
					
					// PageID
					$keys[] = 'PageID';
					$values[] = $v->PageID;
					
					// ItemID
					$keys[] = 'ItemID';
					$values[] = $v->ItemID;
			
					// Is page numbered?
					if (count($v->PageNumbers) > 0)
					{
						$keys[] = 'PagePrefix';
						$values[] = '"' . $v->PageNumbers[0]->Prefix . '"';
			
						$keys[] = 'PageNumber';
						$values[] = '"' . $v->PageNumbers[0]->Number . '"';
					}
			
					if (count($v->PageTypes) > 0)
					{
						$keys[] = 'PageTypeName';
						$values[] = '"' . $v->PageTypes[0]->PageTypeName . '"';
					}
					//$sql = 'DELETE FROM bhl_page WHERE PageID=' . $v->PageID . ';';
					//echo $sql . "\n";
					$sql = 'INSERT INTO bhl_page (' . implode (",", $keys) . ') VALUES (' . implode (",", $values) . ');';
					echo $sql . "\n";
				
				
					// Order of pages
					// pages has PageID as primary key
					$sql = 'REPLACE INTO page (PageID,ItemID,FileNamePrefix,SequenceOrder) VALUES ('
						.        $v->PageID
						. ','  . $v->ItemID
						. ',"' . $obj->Result->SourceIdentifier . sprintf("_%04d",  ($k+1)) . '"'
						. ','  . ($k+1)
						. ');';
						
					echo $sql . "\n";
						
				} 
			}
		}
	}	
}

}

file_put_contents($TitleID . 'djvu.txt', $djvu_string);

?>